<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>AI 数字人管家</title>
    <link rel="stylesheet" href="index.css?=67">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
        /* 添加一些基本的样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f0f0;
        }

        .ai-display {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        .ai-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* 手臂触摸区域：透明小红圈，可拖动 */
        .hand-area {
            position: absolute;
            width: 290px;
            height: 190px;
            border: none; /* 移除边框 */
            background-color: transparent; /* 半透明蓝色，transparent; rgba(127, 127, 241, 0.2); /* 设置背景为透明 */ */
            cursor: grab; /* 手型光标 */
            z-index: 10; /* 确保在最上层 */
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%); /* 初始居中 */
        }

        /* 触摸反馈的样式 */
        .touch-feedback {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .touch-feedback.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.1); /* 透明背景 */
            border-radius: 10px; /* 圆角 */
        }

        .chat-bubble {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            max-width: 70%; /* 限制宽度 */
        }

        .bot-response {
            background-color: rgba(224, 224, 224, 0.5); /* 半透明背景 */
            text-align: left;
            align-self: flex-start;
        }

        .user-input {
            background-color: rgba(209, 231, 221, 0.8); /* 半透明背景 */
            text-align: right;
            align-self: flex-end;
        }

        .mic-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            padding: 20px;
        }

        .mic-icon {
            width: 50px;
            height: 50px;
            cursor: pointer;
        }

        .right-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
        }

        .button-item {
            margin: 10px;
            padding: 10px 20px;
            background-color: #76bdfc;
            color: #fff;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }

        .button-item:hover {
            background-color: #76bdfc;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .recording-indicator {
            display: none;
            color: red;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

        .volume-indicator {
            margin-top: 2px;
            font-size: 6px;
            color: #666;
            text-align: center;
        }

        /* 新增的聆听中提示文本样式 */
        .listening-text {
            position: absolute;
            top: -40px; /* 调整位置，使其在按钮上方显示 */
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #ffffff;
            background-color: transparent; /* 背景颜色改为透明 */
            padding: 5px 10px;
            border-radius: 5px;
            display: none; /* 默认隐藏 */
        }
    </style>
</head>
<body>
    <!--video id="video" width="70" height="70" autoplay></video-->
    <!-- 悬浮容器 -->
    <div id="floating-container">
        <video id="video" autoplay></video>
        <!-- 使用本地图片作为按钮图标 -->
        <button id="toggle-switch-camera">
            <img src="camera-icon.png" alt="摄像头图标">
        </button>
    </div>
    
        <!-- 数字人显示区域 -->
    <div class="ai-display">
        <iframe id="ai-frame" src="" title="AI 数字人" class="ai-frame"></iframe>
        
        <!-- 手臂触摸交互区域（小红圈可拖动） -->
        <div class="hand-area"></div>

        <!-- 触摸反馈显示区域 -->
        <div class="touch-feedback"></div>
    </div>

    <!-- 对话框区域 -->
    <div class="chat-area"></div>

    <!-- 底部麦克风按钮 -->
    <div class="mic-button">
        <img src="mic-icon.png" alt="麦克风" class="mic-icon" id="start">/

        <!-- 新增的聆听中提示文本 -->
        <div class="listening-text">聆听中……</div>
    </div>

    <!-- 右侧功能按钮 -->
    <!-- <div class="right-buttons">
        <div class="button-item" id="end">结束</div>
        <div class="button-item" id="pause">暂停</div>
        <div class="button-item" id="resume">恢复</div>
    </div> -->

    <!-- 录音指示器 -->
    <div id="recordingIndicator" class="recording-indicator">录音中...</div>

    <!-- 音量指示器 -->
    <div id="volumeIndicator" class="volume-indicator"></div>

    <!-- 错误模态框 -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('errorModal')">&times;</span>
            <p class="modal-body"></p>
        </div>
    </div>

    <!-- 成功模态框 -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('successModal')">&times;</span>
            <p class="modal-body"></p>
        </div>
    </div>

    <!-- 引入外部脚本 -->
    <script src="../dist/speechrecognizer.js"></script>
    <script src="config.js?124"></script>
    <script src="asrauthentication.js"></script>

    <!-- 注释掉 vConsole 的引入和初始化代码，留着以后用 -->

    
    <!-- 动态加载 vConsole -->
    <script>
        // 动态加载 vConsole 脚本
        function loadScript(src, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.onload = callback; // 加载成功后的回调
            script.onerror = function() {
                console.error('Failed to load script: ' + src);
                callback(); // 即使加载失败，也执行回调
            };
            document.head.appendChild(script);
        }

        // 加载 vConsole
        loadScript('https://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js', function() {
            if (typeof VConsole !== 'undefined') {
                var vConsole = new VConsole();
                console.log('vConsole 初始化成功');

                // 示例：在页面加载后 5 秒关闭 vConsole
                setTimeout(function() {
                    if (vConsole) {
                        vConsole.destroy();
                        vConsole = null;
                        console.log('vConsole 已销毁');
                    }
                }, 5000000); // 5 秒后销毁
            } else {
                console.warn('vConsole 加载失败，跳过初始化');
            }
        });
    </script>

   
   <script>
        
        // 新增的 JavaScript 逻辑
        const micButton = document.querySelector('.mic-button');
        const listeningText = document.querySelector('.listening-text');

        // 按下麦克风按钮时显示提示文本
        micButton.addEventListener('mousedown', function () {
            listeningText.style.display = 'block'; // 显示文本
        });

        // 释放麦克风按钮时隐藏提示文本
        micButton.addEventListener('mouseup', function () {
            listeningText.style.display = 'none'; // 隐藏文本
        });

        // 如果用户将鼠标移出按钮范围，也隐藏提示文本
        micButton.addEventListener('mouseleave', function () {
            listeningText.style.display = 'none'; // 隐藏文本
        });

        // 动态选择内网或外网地址
        const internalUrl = "https://192.168.1.70:9010/webrtcapi.html";
        const externalUrl = "https://101.10.110.62:9010/webrtcapi.html"; 
        const aiFrame = document.getElementById('ai-frame');

        function setIframeSource() {
            const isInternalNetwork = checkInternalNetwork();
            if (isInternalNetwork) {
                console.log('当前在内网环境，使用内网地址');
                aiFrame.src = internalUrl;
            } else {
                console.log('当前在外网环境，使用外网地址');
                aiFrame.src = externalUrl;
            }
        }

        function checkInternalNetwork() {
            const internalIPRanges = [
                /^192\.168\.\d{1,3}\.\d{1,3}$/,
                /^10\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,
                /^172\.(1[6-9]|2\d|3[0-1])\.\d{1,3}\.\d{1,3}$/
            ];
            const currentUrl = window.location.hostname;
            for (const range of internalIPRanges) {
                if (range.test(currentUrl)) {
                    return true;
                }
            }
            return false;
        }

        // 页面加载完成后设置 iframe 的 src
        setIframeSource();

    
        // 实现触摸反馈与拖动功能
        const handArea = document.querySelector('.hand-area');
        const feedback = document.querySelector('.touch-feedback');

        // 添加检查，确保 handArea 存在
        if (handArea) {
            let isDragging = false; // 是否拖动中
            let dragStartTimeout; // 长按计时器
            let startX, startY, elementX, elementY; // 鼠标初始位置和元素初始位置

            handArea.addEventListener('mousedown', (event) => {
                // 长按判断
                dragStartTimeout = setTimeout(() => {
                    isDragging = true; // 长按后进入拖动状态
                    handArea.style.cursor = 'grabbing';

                    // 获取鼠标和元素的初始位置
                    startX = event.clientX;
                    startY = event.clientY;
                    const rect = handArea.getBoundingClientRect();
                    elementX = rect.left;
                    elementY = rect.top;
                }, 500); // 长按 500ms
            });

            document.addEventListener('mousemove', (event) => {
                if (isDragging) {
                    const deltaX = event.clientX - startX;
                    const deltaY = event.clientY - startY;
                    handArea.style.left = `${elementX + deltaX}px`;
                    handArea.style.top = `${elementY + deltaY}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                clearTimeout(dragStartTimeout); // 清除长按计时器
                if (isDragging) {
                    isDragging = false; // 停止拖动
                    handArea.style.cursor = 'grab';
                }
            });

            // 触摸支持（移动端适配）
            handArea.addEventListener('touchstart', (event) => {
                dragStartTimeout = setTimeout(() => {
                    isDragging = true;
                    handArea.style.cursor = 'grabbing';
                    const touch = event.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    const rect = handArea.getBoundingClientRect();
                    elementX = rect.left;
                    elementY = rect.top;
                }, 500);
            });

            document.addEventListener('touchmove', (event) => {
                if (isDragging) {
                    const touch = event.touches[0];
                    const deltaX = touch.clientX - startX;
                    const deltaY = touch.clientY - startY;
                    handArea.style.left = `${elementX + deltaX}px`;
                    handArea.style.top = `${elementY + deltaY}px`;
                }
            });

            document.addEventListener('touchend', () => {
                clearTimeout(dragStartTimeout);
                if (isDragging) {
                    isDragging = false;
                    handArea.style.cursor = 'grab';
                }
            });
        
        } else {
            console.error('hand-area element not found');
        }
        
    </script>
    
    <script src="index_noauto.js?f=1250"></script>
</body>
</html>