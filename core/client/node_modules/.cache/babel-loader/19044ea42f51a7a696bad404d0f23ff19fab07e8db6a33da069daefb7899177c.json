{"ast":null,"code":"// src/components/AudioTranscriber.jsx\nimport React,{useState,useRef,useEffect}from'react';import micIcon from'../assets/icons/mic-icon.png';import styles from'./AudioTranscriber.module.css';import{useRecorder}from'../hooks/useRecorder';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function AudioTranscriber(){const[isRecording,setIsRecording]=useState(false);const[transcription,setTranscription]=useState('');const[lang,setLang]=useState('auto');const[speakerVerification,setSpeakerVerification]=useState(false);const recorder=useRecorder();const wsRef=useRef(null);const intervalRef=useRef(null);useEffect(()=>{return()=>{// 组件卸载时清理\nstopRecording();};},[]);function startRecording(){if(isRecording)return;// 构造WebSocket地址，注意根据实际地址修改\nlet params=[];if(lang)params.push(\"lang=\".concat(encodeURIComponent(lang)));if(speakerVerification)params.push('sv=1');const queryStr=params.length>0?\"?\".concat(params.join('&')):'';const wsUrl=\"ws://192.168.168.77:6007/ws/transcribe\".concat(queryStr);const ws=new WebSocket(wsUrl);ws.binaryType='arraybuffer';ws.onopen=()=>{console.log('WebSocket 已连接');recorder.start().catch(e=>{alert('启动录音失败: '+e.message);ws.close();});intervalRef.current=setInterval(()=>{if(ws.readyState===1){const audioBlob=recorder.getAudioBlob();if(audioBlob.size>0){console.log('发送音频数据，大小：',audioBlob.size);ws.send(audioBlob);recorder.clearBuffer();}}},500);};ws.onmessage=evt=>{try{const resJson=JSON.parse(evt.data);if(resJson.code===0){setTranscription(prev=>prev+'\\n'+(resJson.data||'无识别结果'));}else{// 其他情况也追加显示\nsetTranscription(prev=>prev+'\\n'+evt.data);}}catch(e){console.error('解析转写消息失败',e);setTranscription(prev=>prev+'\\n'+evt.data);}};ws.onclose=()=>{console.log('WebSocket 已关闭');stopRecording();};ws.onerror=e=>{console.error('WebSocket 错误',e);};wsRef.current=ws;setIsRecording(true);}function stopRecording(){if(!isRecording)return;if(wsRef.current){wsRef.current.close();wsRef.current=null;}recorder.stop();if(intervalRef.current){clearInterval(intervalRef.current);intervalRef.current=null;}setIsRecording(false);}return/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:700,margin:'20px auto',fontFamily:'Arial, sans-serif'},children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>isRecording?stopRecording():startRecording(),style:{padding:'8px 16px',fontSize:16,backgroundColor:isRecording?'red':'#4CAF50',color:'white',border:'none',borderRadius:4,cursor:'pointer',marginBottom:12},children:isRecording?'Stop Recording':'Start Recording'}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:12},children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"langInput\",style:{marginRight:8},children:\"Language:\"}),/*#__PURE__*/_jsx(\"input\",{id:\"langInput\",type:\"text\",value:lang,onChange:e=>setLang(e.target.value),disabled:isRecording,style:{padding:4,fontSize:14,width:120},placeholder:\"auto\"})]}),/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:20},children:/*#__PURE__*/_jsxs(\"label\",{children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:speakerVerification,disabled:isRecording,onChange:e=>setSpeakerVerification(e.target.checked),style:{marginRight:6}}),\"Speaker Verification\"]})}),/*#__PURE__*/_jsx(\"div\",{id:\"transcriptionResult\",style:{whiteSpace:'pre-wrap',backgroundColor:'#f5f5f5',padding:10,border:'1px solid #ddd',borderRadius:5,minHeight:150,fontFamily:'monospace',fontSize:14,overflowY:'auto',maxHeight:300},children:transcription||'Transcription result will be displayed here...'})]});}","map":{"version":3,"names":["React","useState","useRef","useEffect","micIcon","styles","useRecorder","jsx","_jsx","jsxs","_jsxs","AudioTranscriber","isRecording","setIsRecording","transcription","setTranscription","lang","setLang","speakerVerification","setSpeakerVerification","recorder","wsRef","intervalRef","stopRecording","startRecording","params","push","concat","encodeURIComponent","queryStr","length","join","wsUrl","ws","WebSocket","binaryType","onopen","console","log","start","catch","e","alert","message","close","current","setInterval","readyState","audioBlob","getAudioBlob","size","send","clearBuffer","onmessage","evt","resJson","JSON","parse","data","code","prev","error","onclose","onerror","stop","clearInterval","style","maxWidth","margin","fontFamily","children","onClick","padding","fontSize","backgroundColor","color","border","borderRadius","cursor","marginBottom","htmlFor","marginRight","id","type","value","onChange","target","disabled","width","placeholder","checked","whiteSpace","minHeight","overflowY","maxHeight"],"sources":["D:/XM/AI-Sphere-Butler/core/client/src/components/AudioTranscriber.jsx"],"sourcesContent":["// src/components/AudioTranscriber.jsx\r\nimport React, { useState, useRef, useEffect } from 'react';\r\nimport micIcon from '../assets/icons/mic-icon.png';\r\nimport styles from './AudioTranscriber.module.css';\r\nimport { useRecorder } from '../hooks/useRecorder';\r\n\r\nexport default function AudioTranscriber() {\r\n  const [isRecording, setIsRecording] = useState(false);\r\n  const [transcription, setTranscription] = useState('');\r\n\r\n  const [lang, setLang] = useState('auto');\r\n  const [speakerVerification, setSpeakerVerification] = useState(false);\r\n\r\n  const recorder = useRecorder();\r\n  const wsRef = useRef(null);\r\n  const intervalRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      // 组件卸载时清理\r\n      stopRecording();\r\n    };\r\n  }, []);\r\n\r\n  function startRecording() {\r\n    if (isRecording) return;\r\n\r\n    // 构造WebSocket地址，注意根据实际地址修改\r\n    let params = [];\r\n    if (lang) params.push(`lang=${encodeURIComponent(lang)}`);\r\n    if (speakerVerification) params.push('sv=1');\r\n    const queryStr = params.length > 0 ? `?${params.join('&')}` : '';\r\n    const wsUrl = `ws://192.168.168.77:6007/ws/transcribe${queryStr}`;\r\n\r\n    const ws = new WebSocket(wsUrl);\r\n    ws.binaryType = 'arraybuffer';\r\n\r\n    ws.onopen = () => {\r\n      console.log('WebSocket 已连接');\r\n      recorder.start().catch((e) => {\r\n        alert('启动录音失败: ' + e.message);\r\n        ws.close();\r\n      });\r\n\r\n      intervalRef.current = setInterval(() => {\r\n        if (ws.readyState === 1) {\r\n          const audioBlob = recorder.getAudioBlob();\r\n          if (audioBlob.size > 0) {\r\n            console.log('发送音频数据，大小：', audioBlob.size);\r\n            ws.send(audioBlob);\r\n            recorder.clearBuffer();\r\n          }\r\n        }\r\n      }, 500);\r\n    };\r\n\r\n    ws.onmessage = (evt) => {\r\n      try {\r\n        const resJson = JSON.parse(evt.data);\r\n        if (resJson.code === 0) {\r\n          setTranscription((prev) => prev + '\\n' + (resJson.data || '无识别结果'));\r\n        } else {\r\n          // 其他情况也追加显示\r\n          setTranscription((prev) => prev + '\\n' + evt.data);\r\n        }\r\n      } catch (e) {\r\n        console.error('解析转写消息失败', e);\r\n        setTranscription((prev) => prev + '\\n' + evt.data);\r\n      }\r\n    };\r\n\r\n    ws.onclose = () => {\r\n      console.log('WebSocket 已关闭');\r\n      stopRecording();\r\n    };\r\n\r\n    ws.onerror = (e) => {\r\n      console.error('WebSocket 错误', e);\r\n    };\r\n\r\n    wsRef.current = ws;\r\n    setIsRecording(true);\r\n  }\r\n\r\n  function stopRecording() {\r\n    if (!isRecording) return;\r\n\r\n    if (wsRef.current) {\r\n      wsRef.current.close();\r\n      wsRef.current = null;\r\n    }\r\n    recorder.stop();\r\n    if (intervalRef.current) {\r\n      clearInterval(intervalRef.current);\r\n      intervalRef.current = null;\r\n    }\r\n    setIsRecording(false);\r\n  }\r\n\r\n  return (\r\n    <div style={{ maxWidth: 700, margin: '20px auto', fontFamily: 'Arial, sans-serif' }}>\r\n      <button\r\n        onClick={() => (isRecording ? stopRecording() : startRecording())}\r\n        style={{\r\n          padding: '8px 16px',\r\n          fontSize: 16,\r\n          backgroundColor: isRecording ? 'red' : '#4CAF50',\r\n          color: 'white',\r\n          border: 'none',\r\n          borderRadius: 4,\r\n          cursor: 'pointer',\r\n          marginBottom: 12,\r\n        }}\r\n      >\r\n        {isRecording ? 'Stop Recording' : 'Start Recording'}\r\n      </button>\r\n\r\n      <div style={{ marginBottom: 12 }}>\r\n        <label htmlFor=\"langInput\" style={{ marginRight: 8 }}>\r\n          Language:\r\n        </label>\r\n        <input\r\n          id=\"langInput\"\r\n          type=\"text\"\r\n          value={lang}\r\n          onChange={(e) => setLang(e.target.value)}\r\n          disabled={isRecording}\r\n          style={{ padding: 4, fontSize: 14, width: 120 }}\r\n          placeholder=\"auto\"\r\n        />\r\n      </div>\r\n\r\n      <div style={{ marginBottom: 20 }}>\r\n        <label>\r\n          <input\r\n            type=\"checkbox\"\r\n            checked={speakerVerification}\r\n            disabled={isRecording}\r\n            onChange={(e) => setSpeakerVerification(e.target.checked)}\r\n            style={{ marginRight: 6 }}\r\n          />\r\n          Speaker Verification\r\n        </label>\r\n      </div>\r\n\r\n      <div\r\n        id=\"transcriptionResult\"\r\n        style={{\r\n          whiteSpace: 'pre-wrap',\r\n          backgroundColor: '#f5f5f5',\r\n          padding: 10,\r\n          border: '1px solid #ddd',\r\n          borderRadius: 5,\r\n          minHeight: 150,\r\n          fontFamily: 'monospace',\r\n          fontSize: 14,\r\n          overflowY: 'auto',\r\n          maxHeight: 300,\r\n        }}\r\n      >\r\n        {transcription || 'Transcription result will be displayed here...'}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}